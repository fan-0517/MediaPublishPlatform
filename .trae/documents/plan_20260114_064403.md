# 实现计划：发布任务记录相关接口

## 1. 需求分析

用户需要实现发布任务记录的相关接口，包括：

* 记录文件发布到各账号的详细信息

* 支持查询发布任务记录

* 支持更新发布任务状态

* 支持重试和取消发布任务

## 2. 数据库设计

### 2.1 新增发布任务记录表

```sql
CREATE TABLE IF NOT EXISTS publish_task_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT, -- 唯一标识每条记录
    task_id TEXT NOT NULL,                -- 任务ID，用于关联批次任务
    filename TEXT NOT NULL,               -- 文件名
    file_id INTEGER,                      -- 文件ID，关联file_records表
    account_id INTEGER NOT NULL,          -- 账号ID，关联user_info表
    account_name TEXT NOT NULL,           -- 账号名
    platform_name TEXT NOT NULL,          -- 平台名称
    platform_type INTEGER NOT NULL,       -- 平台类型
    status TEXT NOT NULL DEFAULT '待发布',-- 发布状态：待发布、发布中、发布成功、发布失败
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP, -- 创建时间
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP, -- 更新时间
    error_msg TEXT                        -- 错误信息，发布失败时存储
)
```

### 2.2 修改现有表结构

* 不需要修改现有表结构

## 3. API设计

### 3.1 新增API端点

1. **获取发布任务记录**

   * URL: `/getPublishTaskRecords`

   * Method: GET

   * 参数:

     * page: 页码

     * page\_size: 每页条数

     * status: 发布状态（可选）

     * platform\_name: 平台名称（可选）

     * account\_name: 账号名（可选）

     * filename: 文件名（可选）

   * 返回: 发布任务记录列表

2. **更新发布任务状态**

   * URL: `/updatePublishTaskStatus`

   * Method: POST

   * 参数:

     * id: 任务记录ID

     * status: 新状态

     * error\_msg: 错误信息（可选）

   * 返回: 更新结果

3. **重试发布任务**

   * URL: `/retryPublishTask`

   * Method: POST

   * 参数:

     * id: 任务记录ID

   * 返回: 重试结果

4. **取消发布任务**

   * URL: `/cancelPublishTask`

   * Method: POST

   * 参数:

     * id: 任务记录ID

   * 返回: 取消结果

### 3.2 修改现有API端点

1. **修改视频发布相关API**

   * 在`/postVideo`、`/postVideosToMultiplePlatforms`等发布视频的API中，添加发布任务记录的创建逻辑

## 4. 实现步骤

### 4.1 数据库表创建

1. 在`db/createTable.py`中添加发布任务记录表的创建语句
2. 运行脚本创建表

### 4.2 后端API实现

1. 在`sau_backend.py`中添加发布任务记录相关的API端点
2. 实现获取发布任务记录的逻辑
3. 实现更新发布任务状态的逻辑
4. 实现重试发布任务的逻辑
5. 实现取消发布任务的逻辑
6. 修改现有发布视频的API，添加创建发布任务记录的逻辑

### 4.3 前端API调用

1. 在`publish.js`中更新API调用，确保发布任务记录能够正确创建和更新
2. 在Dashboard.vue中使用更新后的API获取发布任务记录

## 5. 技术要点

* 使用SQLite数据库存储发布任务记录

* 实现分页查询功能，提高查询效率

* 确保发布任务状态的正确更新

* 支持批量操作，提高系统性能

* 实现错误处理和日志记录

## 6. 预期效果

* 能够记录每个文件发布到每个账号的详细信息

* 能够查询和筛选发布任务记录

* 能够更新发布任务状态

* 能够重试和取消发布任务

* 发布任务记录与前端展示保持一致

